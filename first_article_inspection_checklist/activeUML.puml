@startuml
'============================================================
title MES 首件檢查表作業流程（2025最新修正版：表單產生後必進填寫介面）
skinparam shadowing false
skinparam monochrome true

|產線人員|
start

:1. 登入系統;
:判斷角色 (產線/主管/QA/Manager);

if (角色 == QA ?) then (是)
  :僅顯示簽核介面;
  stop
endif

if (角色 == Manager ?) then (是)
  :開啟管理者完整功能;
endif

:2. 選取製品類型;

|MES系統|
:讀取該製品類型的檢查分類;
note right: 若無「其他」分類則自動新增一筆 end note

|產線主管|
if (今日尚未安排人員 ?) then (是)
  |產線人員|
  :顯示「今日未安排人員，請聯繫主管」;
  stop
endif

|產線人員|
:5. 輸入工單號碼;

|MES系統|
:驗證並載入工單檔頭資料;
if (工單不存在或載入失敗 ?) then (是)
  |產線人員|
  :顯示「工單載入失敗，請檢查ERP連線」;
  stop
endif

if (工單製品類型 != 選取的製品類型 ?) then (是)
  |產線人員|
  :顯示「工單類型與選取類型不符」;
  stop
endif

'=== 重點：無論沿用或新建，都一定要產生今日表單並進入填寫畫面 ===
|MES系統|
if (今日工單 == 昨日同一工單 ?) then (是)
  :查詢昨日已結案的首件檢查表;
  |產線人員|
  :詢問「是否沿用昨日檢查資料？」;

  if (選擇沿用 ?) then (是)
    |MES系統|
    :建立今日新表單\n完整複製昨日所有檢查項目數值;
    :自動更新表頭為今日日期、台數、序號等;
    :自動帶入今日主管安排的人員;
  else (否)
    |MES系統|
    :建立今日空白新表單;
  endif
else (不是同一工單)
  :建立今日空白新表單;
endif

'=== 以下所有路徑一定會匯流到這裡 ===
:自動帶入工單檔頭資訊;
:自動帶入BOM規格（如可取得）;
:自動帶入今日填表人員（依line_assignment）;

|產線人員|
:【進入首件檢查表填寫介面】;
note right: 分類、項目、規格、實測值\n手寫欄位、照片上傳等

:10. 進行實物檢查並填寫資料;

fork
  :每30秒自動儲存為 Draft;
fork again
  :可隨時手動按「暫存」;
end fork

if (表單未完成且隔日登入 ?) then (是)
  :彈出「需重新安排人員」視窗;
  if (主管尚未重新指派 ?) then (是)
    :無法繼續填寫;
    stop
  endif
endif

:12. 按「送出」送主管審核;
|MES系統|
:狀態變更為 review_request;

|產線主管|
:13. 登入審核 → 查看待審核清單;
if (必填欄位皆已填 ?) then (是)
  :主管簽名確認;
  |MES系統|
  :同時推播至「待製造簽核」與「待品保簽核」;
else (有空白)
  :詢問「是否有空白欄位，是否強制送出？」;
  if (強制送出 ?) then (是)
    :須輸入理由;
    |MES系統|
    :記錄強制送出註記;
    :同時推播至製造與品保簽核;
  else (否)
    :退回填表人員修改;
    stop
  endif
endif

fork
  |製造負責人|
  :登入簽核;
  if (通過 ?) then (是)
    :記錄製造簽核;
  else (否)
    :退回修改;
    stop
  endif
fork again
  |品保人員|
  :登入簽核;
  if (通過 ?) then (是)
    :記錄品保簽核;
  else (否)
    :退回修改;
    stop
  endif
end fork

|MES系統|
if (主管 + 製造 + 品保 三方皆已簽核 ?) then (是)
  :狀態變更為「已結案 closed」;
  :表單設為唯讀;
  stop
endif

|管理者|
if (Manager需修改已結案表單 ?) then (是)
  :必須輸入修改理由並記錄Change Log;
  :修改後重新觸發簽核流程;
endif

|使用者|
:18. 進入歷史查詢;
|MES系統|
:提供多條件查詢（保存至少3年）;
stop

@enduml